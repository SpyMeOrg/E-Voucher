# آلية ربط Binance API

## المتطلبات الأساسية
1. Binance API Key
2. Binance Secret Key
3. خدمة Proxy لتجاوز مشاكل CORS (نستخدم حالياً: https://cors-proxy.fringe.zone/)

## خطوات الربط الناجحة

### 1. إعداد الخدمة
```typescript
private baseUrl = 'https://api.binance.com';
private proxyUrl = 'https://cors-proxy.fringe.zone/';
private recvWindow = 60000; // وقت صلاحية الطلب
```

### 2. التحقق من وقت السيرفر
- نقوم بالتحقق من وقت سيرفر Binance للتأكد من مزامنة التوقيت
- نستخدم endpoint: `/api/v3/time`
- نتجاهل أخطاء المزامنة في حالة الفشل لتجنب توقف الخدمة

### 3. تجهيز الطلب
1. إنشاء timestamp
2. إضافة المعلمات الأساسية:
   - tradeType: 'BUY'
   - timestamp
   - recvWindow
3. إنشاء التوقيع باستخدام HMAC SHA256
4. إضافة التوقيع للطلب

### 4. إرسال الطلب
```typescript
const url = `${proxyUrl}${baseUrl}/sapi/v1/c2c/orderMatch/listUserOrderHistory`;
headers: {
    'X-MBX-APIKEY': apiKey,
    'Content-Type': 'application/json'
}
```

### 5. معالجة الأخطاء
- 429: تجاوز حد الطلبات
- 418: حظر IP
- التحقق من شكل البيانات المستلمة
- معالجة القيم المفقودة والبيانات غير الصحيحة

### 6. تحويل البيانات
نقوم بتحويل البيانات المستلمة إلى الشكل المطلوب مع مراعاة:
- التعامل مع الأسماء المختلفة للحقول
- تحويل الأرقام بشكل آمن
- توحيد حالات النصوص
- حساب الرسوم والأسعار الفعلية

## نصائح مهمة
1. عدم الاعتماد على شكل ثابت للبيانات
2. إضافة logging كافي للتشخيص
3. التعامل مع جميع حالات الخطأ
4. استخدام قيم افتراضية معقولة
5. التحقق من صحة البيانات قبل استخدامها

## حل المشاكل الشائعة
1. مشكلة CORS: استخدام proxy server
2. مشكلة التوقيت: تجاهل أخطاء المزامنة
3. البيانات المفقودة: استخدام قيم بديلة
4. أخطاء التحويل: التحقق قبل العمليات الحسابية

## الخطوات القادمة للتحسين
1. إضافة caching للبيانات
2. تحسين آلية التعامل مع الأخطاء
3. إضافة retry mechanism
4. تحسين أداء التحويلات
5. إضافة المزيد من الفحوصات الأمنية
