# تقرير تفصيلي لمنظومة تكامل Binance API مع E-Voucher

## أولاً: نظرة شاملة على المنظومة

### 1. الهدف الرئيسي
تطوير نظام متكامل يربط بين حاسبة E-Voucher وبيانات Binance P2P لتوفير:
- مراقبة مباشرة لعمليات P2P
- تحليل الأرباح والخسائر
- مقارنة الأسعار المحلية مع أسعار Binance
- تتبع العمولات والرسوم

### 2. طرق الاتصال
#### أ. الخادم المحلي (Local Server)
- **الوصف**: خادم Express يعمل على جهاز المستخدم
- **المميزات**:
  * أمان عالي (المفاتيح تبقى محلية)
  * تخزين مؤقت للبيانات
  * عمل بدون إنترنت للبيانات المخزنة
  * تحكم في Rate Limits
- **العيوب**:
  * يحتاج إعداد على جهاز المستخدم
  * يستهلك موارد الجهاز

#### ب. الاتصال المباشر (Direct Connection)
- **الوصف**: اتصال مباشر من المتصفح لـ Binance API
- **المميزات**:
  * سهولة الاستخدام
  * لا يحتاج إعداد
  * أداء أسرع
- **العيوب**:
  * أقل أماناً
  * لا يوجد تخزين مؤقت
  * يعتمد على الإنترنت دائماً

## ثانياً: التفاصيل التقنية

### 1. واجهات البرمجة المستخدمة
#### أ. Binance API Endpoints
- `GET /sapi/v1/c2c/orderMatch/listUserOrderHistory`
  * تاريخ الأوردرات
  * فلترة حسب النوع والتاريخ
- `GET /sapi/v1/c2c/ads/list`
  * قائمة الإعلانات النشطة
  * أسعار البيع والشراء الحالية

#### ب. WebSocket Endpoints
- `ws://stream.binance.com:9443/ws/c2c`
  * تحديثات مباشرة للأسعار
  * إشعارات العمليات الجديدة

### 2. هيكل البيانات
#### أ. نموذج الأوردر (OrderModel)
```typescript
interface OrderModel {
  orderId: string;
  type: 'BUY' | 'SELL';
  asset: string;
  fiatCurrency: string;
  price: number;
  amount: number;
  totalPrice: number;
  status: OrderStatus;
  createTime: number;
  commission: number;
}
```

#### ب. نموذج الإعلان (AdvertisementModel)
```typescript
interface AdvertisementModel {
  advNo: string;
  asset: string;
  fiatCurrency: string;
  price: number;
  minLimit: number;
  maxLimit: number;
  payMethods: PayMethod[];
}
```

### 3. معالجة البيانات
#### أ. التخزين المؤقت
- تخزين الأوردرات في IndexedDB
- تحديث كل 5 دقائق
- حفظ لمدة 24 ساعة

#### ب. المزامنة
- مزامنة تلقائية عند الاتصال
- مزامنة يدوية عند الطلب
- تعامل مع حالات عدم الاتصال

## ثالثاً: ميزات النظام

### 1. إدارة البيانات
#### أ. استيراد البيانات
- استيراد تلقائي من Binance
- استيراد يدوي من ملف Excel
- دمج البيانات من المصدرين

#### ب. تصدير البيانات
- تصدير لـ Excel
- تقارير PDF
- نسخ احتياطي للإعدادات

### 2. التحليل والمراقبة
#### أ. لوحة المعلومات
- إحصائيات سريعة
- رسوم بيانية
- تنبيهات مباشرة

#### ب. التقارير
- تقارير يومية/أسبوعية/شهرية
- تحليل الربحية
- مقارنة الأسعار

### 3. الأمان والخصوصية
#### أ. إدارة المفاتيح
- تشفير المفاتيح محلياً
- عدم تخزين دائم
- تجديد تلقائي للجلسات

#### ب. حماية البيانات
- تشفير البيانات المخزنة
- نظام صلاحيات
- سجل النشاطات

## رابعاً: خطة التنفيذ

### المرحلة الأولى: الأساسيات (2-3 أسابيع)
1. إعداد هيكل المشروع
2. تنفيذ الاتصال المباشر
3. واجهة مستخدم بسيطة
4. عرض الأوردرات الأساسي

### المرحلة الثانية: التطوير (3-4 أسابيع)
1. إضافة الخادم المحلي
2. نظام التخزين المؤقت
3. الفلاتر والبحث المتقدم
4. التقارير الأساسية

### المرحلة الثالثة: التحسينات (2-3 أسابيع)
1. تحسين الأداء
2. الميزات المتقدمة
3. اختبارات شاملة
4. توثيق المستخدم

## خامساً: اعتبارات مهمة

### 1. الأداء
- تحميل تدريجي للبيانات
- تحسين الذاكرة
- ضغط البيانات

### 2. قابلية التوسع
- تصميم مرن
- وحدات مستقلة
- توثيق شامل

### 3. تجربة المستخدم
- واجهة بسيطة
- أدوات مساعدة
- تعليمات استخدام

## سادساً: المتطلبات التقنية

### 1. الخادم المحلي
- Node.js
- Express
- SQLite/IndexedDB

### 2. الواجهة الأمامية
- React
- TypeScript
- TailwindCSS

### 3. الأدوات المساعدة
- WebSocket
- Axios
- Chart.js

## سابعاً: الصيانة والدعم

### 1. المراقبة
- سجلات الأخطاء
- مراقبة الأداء
- تنبيهات النظام

### 2. التحديثات
- تحديثات أمنية
- تحسينات الأداء
- ميزات جديدة

### 3. الدعم
- وثائق تقنية
- دليل المستخدم
- حل المشكلات

## ثامناً: آلية التخزين الذكي للبيانات

### 1. المبدأ الأساسي
- البيانات المستوردة من Binance تتميز بأنها:
  * ثابتة ولا تتغير (العمليات لا تُحذف ولا تُعدل)
  * تراكمية (يتم إضافة عمليات جديدة فقط)
  * مرتبطة بمفاتيح API محددة

### 2. آلية التخزين المحلي
#### أ. هيكل البيانات
```typescript
interface StorageStructure {
  keyHash: string;           // hash مشفر للمفاتيح
  userData: {
    lastSync: Date;         // آخر مزامنة
    firstOrderDate: Date;   // تاريخ أول عملية
    lastOrderDate: Date;    // تاريخ آخر عملية
  };
  orders: {
    [orderId: string]: BinanceOrder;  // العمليات مخزنة برقم العملية
  };
}
```

#### ب. آلية المزامنة الذكية
1. عند إدخال مفاتيح API:
   - إنشاء hash مشفر للمفاتيح
   - البحث في التخزين المحلي
   - إذا وجدت بيانات:
     * عرض البيانات المخزنة فوراً
     * جلب العمليات الجديدة فقط (بعد lastOrderDate)
   - إذا لم توجد:
     * جلب كل العمليات من Binance
     * تخزينها في IndexedDB

2. تحديث البيانات:
   - جلب العمليات الجديدة فقط
   - دمج مع البيانات المخزنة
   - تحديث lastSync و lastOrderDate

### 3. مميزات النظام
- تقليل طلبات API بشكل كبير
- سرعة عرض البيانات (من التخزين المحلي)
- توفير في استهلاك Rate Limit
- عمل بدون إنترنت للبيانات المخزنة

### 4. إدارة التخزين
- لا حاجة لحذف بيانات قديمة (البيانات ثابتة)
- حجم البيانات معقول ولا يحتاج لتحديد سقف
- خيار "مسح المخزن" متاح للمستخدم
- إمكانية نقل البيانات بين الأجهزة (مستقبلاً)

### 5. خطة التطوير المستقبلي
#### أ. تخزين سحابي
- نقل البيانات المخزنة لخادم مركزي
- مزامنة بين الأجهزة المختلفة
- نظام مصادقة للوصول للبيانات

#### ب. ميزات متقدمة
- مشاركة البيانات بين الحسابات
- نسخ احتياطي تلقائي
- تحليلات متقدمة للبيانات المجمعة

### 6. مثال عملي للتنفيذ
```typescript
class BinanceDataManager {
  async syncData(apiKey: string, secretKey: string) {
    const keyHash = this.generateKeyHash(apiKey, secretKey);
    const storedData = await this.getStoredData(keyHash);
    
    if (storedData) {
      // عرض البيانات المخزنة فوراً
      this.displayData(storedData.orders);
      
      // جلب البيانات الجديدة في الخلفية
      const newOrders = await this.fetchNewOrders(
        storedData.userData.lastOrderDate
      );
      
      if (newOrders.length > 0) {
        await this.mergeAndStore(keyHash, storedData, newOrders);
        this.updateDisplay(newOrders);
      }
    } else {
      // جلب كل البيانات لأول مرة
      const allOrders = await this.fetchAllOrders();
      await this.storeData(keyHash, allOrders);
      this.displayData(allOrders);
    }
  }
}
